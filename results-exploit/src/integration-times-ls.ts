import { mkdirSync, readdirSync, readFileSync, writeFileSync } from 'fs'
import { LogootSRopes } from 'mute-structs'

function random(max: number) {
  return Math.floor(Math.random() * (max + 1))
}

export function computeIntegrationTimesLS() {
  const folderRoot = '../results/150k-op-10-nodes-80-20-until-60k-char-then-50-50/snapshots/ls'
  const parentOfFolderTarget =
    '../results/150k-op-10-nodes-80-20-until-60k-char-then-50-50/integration-times/integration-times-ls'
  const nbExistingSamples = readdirSync(parentOfFolderTarget).length
  const folderTarget = `${parentOfFolderTarget}/sample-${nbExistingSamples}`

  const folderList = [
    '1575035319',
    '1575040127',
    '1575290545',
    '1575295934',
    '1575363622',
    '1575374236',
  ]
  const steps = Array.from({ length: 15 }, (_, i) => 10000 + i * 10000)

  mkdirSync(folderTarget)
  steps.forEach((nbope) => {
    const logs: string[] = []
    folderList.forEach((folder) => {
      const filename = `Snapshot.${nbope}.Master.json`
      const fullPath = `${folderRoot}/${folder}/${filename}`
      const snapshot = JSON.parse(readFileSync(fullPath).toString())

      for (let j = 0; j < 500; j++) {
        const localSequence = LogootSRopes.fromPlain(snapshot) as LogootSRopes
        const remoteSequence = LogootSRopes.fromPlain(snapshot) as LogootSRopes

        const index = random(localSequence.str.length)
        const tLocalStart = process.hrtime.bigint()
        const remoteOp = localSequence.insertLocal(index, 'I')
        const tLocalEnd = process.hrtime.bigint()

        const tRemoteStart = process.hrtime.bigint()
        remoteOp.execute(remoteSequence)
        const tRemoteEnd = process.hrtime.bigint()

        const tLocal = tLocalEnd - tLocalStart
        const tRemote = tRemoteEnd - tRemoteStart

        logs.push(`${nbope},local,${tLocal}`)
        logs.push(`${nbope},remote,${tRemote}`)
      }
    })
    writeFileSync(`${folderTarget}/integration-times-ls-${nbope}.csv`, logs.join('\n') + '\n')
  })
}
