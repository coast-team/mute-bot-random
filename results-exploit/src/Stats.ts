import { writeFileSync } from 'fs'
import { mean, median, quantile, standardDeviation } from 'simple-statistics'

export class Stats {
  constructor(logs: any, file: string) {
    const local: number[] = []
    const remote: number[] = []
    logs.forEach((element: any) => {
      // local.push()
      const ls = (element.tLocalAfter[0] - element.tLocalBefore[0]) * 1000
      const lms = (element.tLocalAfter[1] - element.tLocalBefore[1]) / 1000000
      local.push(ls + lms)

      const rs = (element.tRemoteAfter[0] - element.tRemoteBefore[0]) * 1000
      const rms = (element.tRemoteAfter[1] - element.tRemoteBefore[1]) / 1000000
      remote.push(rs + rms)
    })
    writeFileSync(
      file,
      'local:' +
        this.toString(this.processTimes(local)) +
        '\nremote:' +
        this.toString(this.processTimes(remote))
    )
  }

  private toString(res: IResults): string {
    return (
      '{\n' +
      '\tmean: ' +
      res.mean +
      '\n' +
      '\tmedian: ' +
      res.median +
      '\n' +
      '\tninetyNinePercentile: ' +
      res.ninetyNinePercentile +
      '\n' +
      '\tstandardDeviation: ' +
      res.standardDeviation +
      '\n' +
      '}\n'
    )
  }

  private processTimes(times: number[]): IResults {
    const sortedTimes = times.sort((a, b) => a - b)
    return {
      mean: mean(sortedTimes),
      median: median(sortedTimes),
      ninetyNinePercentile: quantile(sortedTimes, 0.99),
      standardDeviation: standardDeviation(sortedTimes),
    }
  }
}

export interface IResults {
  mean: number
  median: number
  ninetyNinePercentile: number
  standardDeviation: number
}
