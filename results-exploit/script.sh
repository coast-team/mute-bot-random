#! /bin/bash


file=`ls snapshots`
count=0
for f in $file
do
  count=$((count+1))
  dossier="experiment-$f-$count"
  mkdir $dossier
  mkdir $dossier/output
  cp -r ./input $dossier
  cp ./docker-compose-parallel.yml ./$dossier
  cp ./snapshots/$f ./$dossier/input/snapshot.json

  chmod 777 -R $dossier
  
  cd $dossier
  docker stack deploy -c ./docker-compose-parallel.yml "result$count"
  cd ..
done

sleep 30
watch -n 30 -g ./check-exp.sh
echo "Experiences have finished !"

count=0
for f in $file
do
  count=$((count+1))
  dossier="experiment-$f-$count"
  ./stats-script.sh "./output/merged-$dossier.json" ./$dossier/output/*
  docker stack rm "result$count"
done

rm -r ./experiment*